# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: self-hosted
    environment: start

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug password issues
        env:
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          echo "Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ:"
          echo "Ð”Ð»Ð¸Ð½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ: ${#DB_PASS} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ 5 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: ${DB_PASS:0:5}"
          echo "ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: ${DB_PASS: -5}"
    
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ðº Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
          echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€:"
          docker run --rm -e TEST_PASSWORD="$DB_PASS" alpine \
          sh -c 'echo "Ð”Ð»Ð¸Ð½Ð° Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ: ${#TEST_PASSWORD}" && echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ 5 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: ${TEST_PASSWORD:0:5}"'

      - name: Create .env file from Environment
        env:
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          {
          echo "# Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¸Ð· Environment (Ð½Ðµ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ)"
          echo "DB_HOST=${{ secrets.DB_HOST }}"
          echo "DB_NAME=${{ secrets.DB_NAME }}"
          echo "DB_PASS=${DB_PASS}"
          echo "DB_USER=${{ secrets.DB_USER }}"

          echo "# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· Environment"
          echo "AGENT_CONTAINER_PORT=${{ vars.AGENT_CONTAINER_PORT }}"
          echo "AGENT_PORT=${{ vars.AGENT_PORT }}"
          echo "AGENT_URL=${{ vars.AGENT_URL }}"
          echo "APP_CONTAINER_PORT=${{ vars.APP_CONTAINER_PORT }}"
          echo "APP_PORT=${{ vars.APP_PORT }}"
          echo "DB_PORT=${{ vars.DB_PORT }}"
          echo "INTRA_SERVICE_URL=${{ vars.INTRA_SERVICE_URL }}"
          } > .env
          
      # Runs a single command using the runners shell
      - name: Deploy with docker compose
        run: |
          docker compose --env-file .env up -d --build
      
      # Health checks 
      - name: Health checks
        run: |
          echo "ðŸ¥ Performing health checks..."
          
          # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ð¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒÑÑ
          sleep 15
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          docker compose ps
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° app
          docker compose logs app --tail=20

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° app-agent
          docker compose logs app-agent --tail=20

      # [CI-BLOCK-1] Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑˆÐ°Ð³ Ð² CI/CD Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
      - name: Debug container permissions
        run: |
          echo "=== Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð°Ð² Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ ==="
          sleep 10
    
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐºÑ‚Ð¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
          docker compose exec -T app-agent whoami
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ UID Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° dotnet
          docker compose exec -T app-agent ps aux | grep dotnet
          
          # Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð²
          docker compose exec -T app-agent bash -c "ls -la /var/www/intraservice.agent/ && echo '---' && ls -la /var/www/intraservice.agent/Certificate/"
          
          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
          docker compose exec -T app-agent cat /var/www/intraservice.agent/Certificate/AuthKey_AW34Z3FWSW.p8 | head -c 100
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ inode Ð¸ Ð´ÐµÑ‚Ð°Ð»Ð¸
          docker compose exec -T app-agent stat /var/www/intraservice.agent/Certificate/
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ SELinux/AppArmor (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
          docker compose exec -T app-agent ls -Z /var/www/intraservice.agent/Certificate/ 2>/dev/null || echo "SELinux Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½"
